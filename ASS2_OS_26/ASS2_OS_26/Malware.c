

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <unistd.h>
typedef struct stack{
    int num;
    struct stack* next;
}stack;
typedef struct{
    int a,b;
    double c;
}info; 
stack* push(stack *h,int val){
    stack *p;
    p = (stack*)malloc(sizeof(stack));
    p->num = val;
    stack *t = h;
    p->next = t;
    h = p;
    return h; 
}
stack* pop(stack* h){
    stack *p = h;
    h = h->next;
    free(p);
    return h;
} 
int top(stack* h){
    return h->num;
} 
int numberChild(int pid){
    char filename[64];
    char line[256];
    int nr_children = 0;
    FILE *file;
    sprintf(filename, "/proc/%d/task/%d/children", pid,pid);
    int nc = 0;
    file = fopen(filename, "r");
    if (file == NULL) {
        printf("Failed to open file %s\n", filename);
        return 1;
    }
    char c;
    c = fgetc(file);
    while (c != EOF)
    {
        if(c == ' ') nc++;
        c = fgetc(file);
    }
    if(c == ' ') nc++;
    fclose(file);
    return nc;
}
double timrTaken(int pid,info* q,int w){
    char buf[1024];
    char path[1024];
    FILE *fp;
    int utime, stime;
    snprintf(path, sizeof(path), "/proc/%d/stat", pid);

    fp = fopen(path, "r");
    if (!fp) {
        perror("fopen");
        return 1;
    }

    if (!fgets(buf, sizeof(buf), fp)) {
        perror("fgets");
        fclose(fp);
        return 1;
    }

    fclose(fp);

    /* Parse the contents of /proc/[pid]/stat */
    sscanf(buf, "%*d %*s %*c %*d %*d %*d %*d %*d %*u %*u %*u %*u %*u %d %d", &utime, &stime);
    int nc = numberChild(pid);
    double ans = utime+stime;
    printf("%d    %d    %lf\n",pid,nc,ans);
    q[w].a = pid;
    q[w].b = nc;
    q[w].c = ans;
  return 0;
}
int get_ppid(int pid) {
    char path[64];
    sprintf(path, "/proc/%d/status", pid);

    FILE *file = fopen(path, "r");
    if (file == NULL) {
        perror("fopen");
        exit(EXIT_FAILURE);
    }

    int ppid = 0;
    char line[256];
    while (fgets(line, sizeof(line), file)) {
        if (strncmp(line, "PPid:", 5) == 0) {
            sscanf(line + 5, "%d", &ppid);
            break;
        }
    }

    fclose(file);
    return ppid;
}
void maini(int pid,int sig){
    stack *h;
    h = (stack*)malloc(sizeof(stack));
    h->num = -1;
    h->next = NULL;
    int nj = 0;
    while(1){
        if(pid == 1) break;
        h = push(h,pid);
        pid = get_ppid(pid);
        nj++;
    }
    info qw[nj];
    int kt = 0;
    while(1){
        int k = top(h);
        if(k == -1) break;
        timrTaken(k,qw,kt);
        h = pop(h);
        kt++;
    }
    h = pop(h);
    double min = qw[0].c;
    int fpid;
    for(int i = 1;i < nj;i++){
        if(min > qw[i].c){
            fpid = qw[i].a;
            min = qw[i].c;
        }
    }
    if(sig == 1) printf("%d  is the root of malware\n",fpid);
    return 0;
}
// int main(int argc, char *argv[]) {
//     int pid;
//     scanf("%d",&pid);
//     stack *h;
//     h = (stack*)malloc(sizeof(stack));
//     h->num = -1;
//     h->next = NULL;
//     int nj = 0;
//     while(1){
//         if(pid == 1) break;
//         h = push(h,pid);
//         pid = get_ppid(pid);
//         nj++;
//     }
//     info qw[nj];
//     int kt = 0;
//     while(1){
//         int k = top(h);
//         if(k == -1) break;
//         timrTaken(k,qw,kt);
//         h = pop(h);
//         kt++;
//     }
//     h = pop(h);
//     double min = qw[0].c;
//     int fpid;
//     for(int i = 1;i < nj;i++){
//         if(min > qw[i].c){
//             fpid = qw[i].a;
//             min = qw[i].c;
//         }
//     }
//     printf("%d  is the root of malware",fpid);
//     return 0;
// }
